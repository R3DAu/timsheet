<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timesheet Management System</title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>
  <div id="app">
    <!-- Login Screen -->
    <div id="loginScreen" class="screen">
      <div class="container">
        <h1>Timesheet System</h1>
        <div class="card">
          <h2>Login</h2>
          <form id="loginForm">
            <div class="form-group">
              <label for="loginEmail">Email</label>
              <input type="email" id="loginEmail" required>
            </div>
            <div class="form-group">
              <label for="loginPassword">Password</label>
              <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
          </form>
          <div id="loginError" class="error"></div>
        </div>
      </div>
    </div>

    <!-- Main Screen -->
    <div id="mainScreen" class="screen" style="display: none;">
      <header class="topbar">
        <div class="topbar-left">
          <div class="brand">
            <div class="brand-mark">TS</div>
            <div>
              <div class="brand-title">Timesheet</div>
              <div class="brand-subtitle" id="navPageTitle">My Timesheets</div>
            </div>
          </div>
        </div>

        <div class="topbar-right">
          <span class="user-pill"><span class="user-dot"></span><span id="userDisplay">User</span></span>
          <button class="btn btn-secondary btn-sm" id="myProfileBtn">My Profile</button>
          <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>
        </div>
      </header>

      <div class="app-shell">
        <aside class="sidebar">
          <button class="nav-item active" data-tab="timesheets">
            <span class="nav-icon">üìã</span> Timesheets
          </button>
          <button class="nav-item" data-tab="leaveManagement">
            <span class="nav-icon">üèñÔ∏è</span> Leave Requests
          </button>

          <div class="nav-section admin-only">
            <div class="nav-section-title">Admin</div>
            <button class="nav-item" data-tab="approvals"><span class="nav-icon">‚úÖ</span> Approvals <span id="approvalsBadge" class="nav-badge" style="display:none;"></span></button>
            <button class="nav-item" data-tab="employees"><span class="nav-icon">üë§</span> Employees</button>
            <button class="nav-item" data-tab="users"><span class="nav-icon">üßë‚Äçüíª</span> Users</button>
            <button class="nav-item" data-tab="companies"><span class="nav-icon">üè¢</span> Companies</button>
            <button class="nav-item" data-tab="roles"><span class="nav-icon">üßæ</span> Roles</button>
            <button class="nav-item" data-tab="apiKeys"><span class="nav-icon">üîë</span> API Keys</button>
            <button class="nav-item" data-tab="systemTools"><span class="nav-icon">üîß</span> System Tools</button>
          </div>

          <div class="nav-section admin-only">
            <div class="nav-section-title">Xero Integration</div>
            <button class="nav-item" data-tab="xeroDashboard"><span class="nav-icon">üìà</span> Dashboard</button>
            <button class="nav-item" data-tab="xeroSetup"><span class="nav-icon">‚öôÔ∏è</span> Xero Setup</button>
            <button class="nav-item" data-tab="xeroSyncLogs"><span class="nav-icon">üìä</span> Sync Logs</button>
            <button class="nav-item" data-tab="xeroInvoices"><span class="nav-icon">üßæ</span> Invoices</button>
          </div>
        </aside>

        <main class="main">
          <!-- Unified Timesheets Tab -->
          <div id="timesheetsTab" class="tab-content active">
            <div class="card">
              <div class="card-header">
                <div class="card-header-left">
                  <h2 id="timesheetsHeading">My Timesheets</h2>
                  <div id="employeeSelectorWrapper" class="admin-only" style="display:none;">
                    <div class="employee-selector">
                      <input type="text" id="employeeSearchInput"
                             class="form-control"
                             placeholder="Search employee..."
                             autocomplete="off">
                      <div id="employeeDropdown" class="employee-dropdown" style="display:none;"></div>
                    </div>
                  </div>
                </div>
                <div class="card-header-right">
                  <button id="createTimesheetBtn" class="btn btn-primary">Create Timesheet</button>
                </div>
              </div>
              <div id="timesheetsAccordion" class="accordion-container"></div>
            </div>
          </div>

          <!-- Approvals Tab (Admin) -->
          <div id="approvalsTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>Approvals</h2>
              </div>
              <div id="approvalsContent"></div>
            </div>
          </div>

          <!-- Employees Tab (Admin) -->
          <div id="employeesTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>Employees</h2>
                <button id="createEmployeeBtn" class="btn btn-primary">Add Employee</button>
              </div>
              <div id="employeesList"></div>
            </div>
          </div>

          <!-- Companies Tab (Admin) -->
          <div id="companiesTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>Companies</h2>
                <button id="createCompanyBtn" class="btn btn-primary">Add Company</button>
              </div>
              <div id="companiesList"></div>
            </div>
          </div>

          <!-- Roles Tab (Admin) -->
          <div id="rolesTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>Roles</h2>
                <button id="createRoleBtn" class="btn btn-primary">Add Role</button>
              </div>
              <div id="rolesList"></div>
            </div>
          </div>

          <!-- Users Tab (Admin) -->
          <div id="usersTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>System Users</h2>
                <button id="createUserBtn" class="btn btn-primary">Add User</button>
              </div>
              <div id="usersList"></div>
            </div>
          </div>

          <!-- API Keys Tab (Admin) -->
          <div id="apiKeysTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>API Keys</h2>
                <button id="createApiKeyBtn" class="btn btn-primary">Create API Key</button>
              </div>
              <div id="apiKeysList"></div>
            </div>
          </div>

          <!-- System Tools Tab (Admin) -->
          <div id="systemToolsTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>System Tools</h2>
              </div>
              <div style="padding: 1.5rem;">
                <!-- TSDATA Cleanup Section -->
                <div class="tool-section" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background: #f9fafb;">
                  <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                    <div style="font-size: 2rem;">üßπ</div>
                    <div style="flex: 1;">
                      <h3 style="margin: 0 0 0.5rem 0; color: #1f2937;">Clean Up Duplicate TSDATA Entries</h3>
                      <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Removes duplicate TSDATA entries that were imported before smart matching was implemented.
                        Finds TSDATA entries with matching local entries (same date/hours), deletes duplicates, and marks local entries as verified.
                      </p>
                      <button id="cleanupDuplicatesBtn" class="btn btn-primary" style="margin-bottom: 0.5rem;">
                        üßπ Run TSDATA Cleanup
                      </button>
                      <div id="cleanupDuplicatesResult" style="margin-top: 1rem;"></div>
                    </div>
                  </div>
                </div>

                <!-- Remove Weekend Entries Section -->
                <div class="tool-section" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background: #f9fafb;">
                  <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                    <div style="font-size: 2rem;">üìÖ</div>
                    <div style="flex: 1;">
                      <h3 style="margin: 0 0 0.5rem 0; color: #1f2937;">Remove Weekend TSDATA Entries</h3>
                      <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Removes all TSDATA entries that fall on Saturday or Sunday. These are typically data quality issues.
                        Future syncs will automatically skip weekend entries.
                      </p>
                      <button id="removeWeekendBtn" class="btn btn-warning" style="margin-bottom: 0.5rem;">
                        üìÖ Remove Weekend Entries
                      </button>
                      <div id="removeWeekendResult" style="margin-top: 1rem;"></div>
                    </div>
                  </div>
                </div>

                <!-- Status Repair Section -->
                <div class="tool-section" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background: #f9fafb;">
                  <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                    <div style="font-size: 2rem;">üîÑ</div>
                    <div style="flex: 1;">
                      <h3 style="margin: 0 0 0.5rem 0; color: #1f2937;">Repair Status Inconsistencies</h3>
                      <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Fixes entries that have incorrect status compared to their parent timesheet.
                        Updates all entries to match their timesheet status (e.g., if timesheet is APPROVED, all entries become APPROVED).
                      </p>
                      <button id="repairStatusBtn" class="btn btn-primary" style="margin-bottom: 0.5rem;">
                        üîÑ Repair Entry Statuses
                      </button>
                      <div id="repairStatusResult" style="margin-top: 1rem;"></div>
                    </div>
                  </div>
                </div>

                <!-- Merge Duplicate Timesheets Section -->
                <div class="tool-section" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background: #f9fafb;">
                  <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                    <div style="font-size: 2rem;">üîÄ</div>
                    <div style="flex: 1;">
                      <h3 style="margin: 0 0 0.5rem 0; color: #1f2937;">Merge Duplicate Timesheets</h3>
                      <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Consolidates timesheets that have the same employee and week range.
                        Keeps the timesheet with the most entries and moves all entries from duplicates to the kept timesheet.
                      </p>
                      <button id="mergeDuplicatesBtn" class="btn btn-warning" style="margin-bottom: 0.5rem;">
                        üîÄ Merge Duplicate Timesheets
                      </button>
                      <div id="mergeDuplicatesResult" style="margin-top: 1rem;"></div>
                    </div>
                  </div>
                </div>

                <!-- Audit Log Section -->
                <div class="tool-section" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; background: #f9fafb;">
                  <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                    <div style="font-size: 2rem;">üìã</div>
                    <div style="flex: 1;">
                      <h3 style="margin: 0 0 0.5rem 0; color: #1f2937;">Audit Log</h3>
                      <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        View a record of significant user actions including logins, timesheet approvals, and status changes.
                      </p>
                      <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <select id="auditActionFilter" class="form-control" style="width: auto; min-width: 180px;">
                          <option value="">All Actions</option>
                        </select>
                        <input type="date" id="auditFromDate" class="form-control" style="width: auto;" title="From date">
                        <input type="date" id="auditToDate" class="form-control" style="width: auto;" title="To date">
                        <button id="loadAuditLogBtn" class="btn btn-primary">Load Audit Log</button>
                      </div>
                      <div id="auditLogResult"></div>
                    </div>
                  </div>
                </div>

                <!-- TSDATA Manual Sync Section -->
                <div class="tool-section" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1.5rem; background: #f9fafb;">
                  <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                    <div style="font-size: 2rem;">üîÑ</div>
                    <div style="flex: 1;">
                      <h3 style="margin: 0 0 0.5rem 0; color: #1f2937;">Manual TSDATA Sync</h3>
                      <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                        Manually trigger a sync from TSDATA to import/update timesheets and entries.
                        Uses smart matching to verify existing entries instead of creating duplicates.
                      </p>
                      <button id="manualSyncBtn" class="btn btn-primary" style="margin-bottom: 0.5rem;">
                        üîÑ Run Manual Sync
                      </button>
                      <div id="manualSyncResult" style="margin-top: 1rem;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Xero Dashboard Tab (Admin) -->
          <div id="xeroDashboardTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>Xero Dashboard</h2>
                <button id="xeroDashboardRefreshBtn" class="btn btn-secondary">Refresh</button>
              </div>
              <div id="xeroDashboardCards" style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;"></div>
              <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <h3 style="margin: 0 0 1rem 0;">Employee Sync Status</h3>
                <div id="xeroDashboardEmployeeTable"></div>
              </div>
              <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <h3 style="margin: 0 0 1rem 0;">Pay Period Status</h3>
                <div id="xeroDashboardPayPeriods"></div>
              </div>
              <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <h3 style="margin: 0 0 1rem 0;">Recent Sync Failures</h3>
                <div id="xeroDashboardFailures"></div>
              </div>
              <div style="padding: 1.5rem;">
                <h3 style="margin: 0 0 1rem 0;">Invoice Summary</h3>
                <div id="xeroDashboardInvoiceSummary"></div>
              </div>
            </div>
          </div>

          <!-- Xero Setup Tab (Admin) -->
          <div id="xeroSetupTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>Xero Integration Setup</h2>
              </div>

              <!-- Connection Section -->
              <div id="xeroConnectionSection" style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                  <div style="font-size: 2rem;">üîó</div>
                  <div style="flex: 1;">
                    <h3 style="margin: 0 0 0.5rem 0;">Xero Connection</h3>
                    <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">
                      Connect your Xero account to enable payroll sync and invoice management.
                    </p>
                    <div id="xeroConnectionStatus"></div>
                    <div style="margin-top: 1rem;">
                      <button id="connectXeroBtn" class="btn btn-primary">Connect Xero</button>
                      <button id="refreshTenantsBtn" class="btn btn-secondary" style="display: none;">Refresh</button>
                    </div>
                  </div>
                </div>
                <div id="xeroTenantsList" style="margin-top: 1rem;"></div>
              </div>

              <!-- Setup Tabs -->
              <div style="padding: 1.5rem;">
                <div class="setup-tabs" style="display: flex; gap: 0.5rem; border-bottom: 2px solid #e5e7eb; margin-bottom: 1.5rem;">
                  <button class="setup-tab-btn active" data-setup-tab="companies">Companies</button>
                  <button class="setup-tab-btn" data-setup-tab="employees">Employees</button>
                  <button class="setup-tab-btn" data-setup-tab="roles">Roles</button>
                  <button class="setup-tab-btn" data-setup-tab="leaveTypes">Leave Types</button>
                  <button class="setup-tab-btn" data-setup-tab="settings">Settings</button>
                  <button class="setup-tab-btn" data-setup-tab="payroll">Payroll</button>
                </div>

                <!-- Company Mapping Tab -->
                <div id="setupCompaniesTab" class="setup-tab-content active">
                  <h3>Company to Xero Tenant Mapping</h3>
                  <p style="color: #6b7280; margin-bottom: 1rem;">
                    Map each company to a Xero tenant and configure invoice settings for Local Technicians.
                  </p>
                  <div id="companyMappingList"></div>
                </div>

                <!-- Employee Mapping Tab -->
                <div id="setupEmployeesTab" class="setup-tab-content">
                  <h3>Employee to Xero Employee Mapping</h3>
                  <p style="color: #6b7280; margin-bottom: 1rem;">
                    Map your local employees to Xero employees for timesheet sync.
                  </p>
                  <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select Xero Tenant:</label>
                    <select id="employeeTenantSelector" class="form-control" style="max-width: 400px;">
                      <option value="">Select a tenant...</option>
                    </select>
                  </div>
                  <div id="employeeMappingList"></div>
                </div>

                <!-- Role Mapping Tab -->
                <div id="setupRolesTab" class="setup-tab-content">
                  <h3>Role to Earnings Rate Mapping</h3>
                  <p style="color: #6b7280; margin-bottom: 1rem;">
                    Map your local roles to Xero earnings rates (pay types).
                  </p>
                  <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select Xero Tenant:</label>
                    <select id="roleTenantSelector" class="form-control" style="max-width: 400px;">
                      <option value="">Select a tenant...</option>
                    </select>
                  </div>
                  <div id="roleMappingList"></div>
                </div>

                <!-- Employee Settings Tab -->
                <div id="setupLeaveTypesTab" class="setup-tab-content">
                  <h3>Leave Type to Xero Leave Type Mapping</h3>
                  <p style="color: #6b7280; margin-bottom: 1rem;">
                    Map each leave type to the corresponding Xero leave type for automatic sync.
                  </p>

                  <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select Xero Tenant:</label>
                    <select id="leaveTypeTenantSelector" class="form-control" style="max-width: 400px;">
                      <option value="">Select tenant...</option>
                    </select>
                  </div>

                  <div id="leaveTypeMappingsList"></div>
                </div>

                <!-- Payroll Tab -->
                <div id="setupPayrollTab" class="setup-tab-content">
                  <h3>Payroll Calendars &amp; Pay Runs</h3>
                  <p style="color: #6b7280; margin-bottom: 1rem;">
                    View your Xero payroll calendar configuration and manage pay runs. Pay runs must exist for a period before timesheets can be synced.
                  </p>
                  <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select Xero Tenant:</label>
                    <select id="payrollTenantSelector" class="form-control" style="max-width: 400px;">
                      <option value="">Select a tenant...</option>
                    </select>
                  </div>
                  <div id="payrollCalendarsList"></div>
                </div>

                <div id="setupSettingsTab" class="setup-tab-content">
                  <h3>Employee Xero Settings</h3>
                  <p style="color: #6b7280; margin-bottom: 1rem;">
                    Configure employee types (Specialist Tech or Local Tech), auto-approval, and sync preferences.
                  </p>
                  <div id="employeeSettingsList"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Xero Sync Logs Tab (Admin) -->
          <div id="xeroSyncLogsTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>Xero Sync Logs</h2>
                <div style="display: flex; gap: 0.5rem;">
                  <button id="refreshSyncLogsBtn" class="btn btn-secondary">Refresh</button>
                </div>
              </div>

              <!-- Stats Cards -->
              <div id="syncStatsCards" style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb;"></div>

              <!-- Filters -->
              <div style="padding: 1rem 1.5rem; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                  <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Status:</label>
                    <select id="syncLogStatusFilter" class="form-control" style="max-width: 150px;">
                      <option value="">All</option>
                      <option value="SUCCESS">Success</option>
                      <option value="ERROR">Error</option>
                      <option value="PENDING">Pending</option>
                      <option value="PARTIAL">Partial</option>
                    </select>
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Type:</label>
                    <select id="syncLogTypeFilter" class="form-control" style="max-width: 200px;">
                      <option value="">All</option>
                      <option value="TIMESHEET_SYNC">Timesheet Sync</option>
                      <option value="INVOICE_CREATE">Invoice Create</option>
                      <option value="LEAVE_SYNC">Leave Sync</option>
                      <option value="RECONCILIATION">Reconciliation</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Logs Table -->
              <div id="syncLogsList" style="padding: 1.5rem;"></div>
            </div>
          </div>

          <!-- Leave Management Tab -->
          <div id="leaveManagementTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>Leave Management</h2>
              </div>

              <!-- Employee View: Leave Requests & Balances -->
              <div id="xero-leave-employee" style="padding: 1.5rem;"></div>

              <!-- Admin View: Pending Approvals & History -->
              <div id="xero-leave-admin" style="padding: 1.5rem; border-top: 1px solid #e5e7eb;"></div>
            </div>
          </div>

          <!-- Xero Invoices Tab (Admin) -->
          <div id="xeroInvoicesTab" class="tab-content">
            <div class="card">
              <div class="card-header">
                <h2>LT Invoices</h2>
              </div>
              <div id="xero-invoices-admin"></div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Slide-in Panel for Entry Editing -->
  <div id="slidePanel" class="slide-panel-overlay">
    <div class="slide-panel">
      <div class="slide-panel-header">
        <h3 id="slidePanelTitle">Edit Entry</h3>
        <button class="slide-panel-close" id="slidePanelClose">&times;</button>
      </div>
      <div class="slide-panel-body" id="slidePanelBody"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
