// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum TimesheetStatus {
  OPEN
  INCOMPLETE
  SUBMITTED
  AWAITING_APPROVAL
  APPROVED
  LOCKED
  UNLOCKED
  PROCESSED
}

enum EntryType {
  TRAVEL
  GENERAL
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  passwordHash  String
  name          String
  isAdmin       Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee      Employee?
  approvals     TimesheetApprover[]
  approvedTimesheets Timesheet[] @relation("ApprovedBy")
}

model Company {
  id          Int      @id @default(autoincrement())
  name        String
  isBillable  Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles            Role[]
  employeeRoles    EmployeeRole[]
  approvers        TimesheetApprover[]
  timesheetEntries TimesheetEntry[]
  employeeIdentifiers EmployeeIdentifier[]
}

model Employee {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  firstName       String
  lastName        String
  email           String   @unique
  phone           String?
  presetAddresses String?  // JSON string
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  identifiers EmployeeIdentifier[]
  roles       EmployeeRole[]
  timesheets  Timesheet[]
}

model EmployeeIdentifier {
  id              Int      @id @default(autoincrement())
  employeeId      Int
  identifierType  String   // e.g., "payroll", "contractor_id", "hr_system"
  identifierValue String
  companyId       Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  company  Company? @relation(fields: [companyId], references: [id])

  @@unique([employeeId, identifierType, companyId])
}

model Role {
  id         Int      @id @default(autoincrement())
  name       String
  companyId  Int
  payRate    Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employeeRoles   EmployeeRole[]
  timesheetEntries TimesheetEntry[]

  @@unique([name, companyId])
}

model EmployeeRole {
  id         Int      @id @default(autoincrement())
  employeeId Int
  roleId     Int
  companyId  Int
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  role     Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([employeeId, roleId, companyId])
}

model Timesheet {
  id           Int              @id @default(autoincrement())
  employeeId   Int
  weekStarting DateTime
  weekEnding   DateTime
  status       TimesheetStatus  @default(OPEN)
  submittedAt  DateTime?
  approvedAt   DateTime?
  approvedById Int?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  employee     Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approvedBy   User?             @relation("ApprovedBy", fields: [approvedById], references: [id])
  entries      TimesheetEntry[]

  @@unique([employeeId, weekStarting])
}

model TimesheetEntry {
  id          Int              @id @default(autoincrement())
  timesheetId Int
  entryType   EntryType
  date        DateTime
  hours       Float
  roleId      Int
  companyId   Int
  status      TimesheetStatus  @default(OPEN)
  notes       String?
  travelFrom  String?
  travelTo    String?
  distance    Float?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  timesheet Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)
  role      Role      @relation(fields: [roleId], references: [id])
  company   Company   @relation(fields: [companyId], references: [id])
}

model TimesheetApprover {
  id        Int      @id @default(autoincrement())
  companyId Int
  userId    Int
  email     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
}

model PlaceCache {
  id            Int      @id @default(autoincrement())
  placeName     String   @unique
  address       String
  latitude      Float
  longitude     Float
  googlePlaceId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
