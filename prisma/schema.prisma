// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Note: SQLite doesn't support enums, so we use String with application-level validation
// Valid values for status: OPEN, INCOMPLETE, SUBMITTED, AWAITING_APPROVAL, APPROVED, LOCKED, UNLOCKED, PROCESSED
// Valid values for entryType: TRAVEL, GENERAL

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  passwordHash  String
  name          String
  isAdmin       Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee           Employee?
  approvals          TimesheetApprover[]
  approvedTimesheets Timesheet[] @relation("ApprovedBy")
  apiKeys            ApiKey[]
  approvedLeaves     LeaveRequest[]
}

model Company {
  id          Int      @id @default(autoincrement())
  name        String
  isBillable      Boolean  @default(true)
  wmsSyncEnabled  Boolean  @default(false)  // Allow DE WMS timesheet sync for this company's entries
  createdAt       DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles               Role[]
  employeeRoles       EmployeeRole[]
  approvers           TimesheetApprover[]
  timesheetEntries    TimesheetEntry[]
  employeeIdentifiers EmployeeIdentifier[]
  xeroMappings        CompanyXeroMapping[]
  xeroInvoices        XeroInvoice[]
}

model Employee {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  firstName       String
  lastName        String
  email           String   @unique
  phone           String?
  presetAddresses String?  // JSON string
  morningStart    String   @default("08:30")  // HH:MM format
  morningEnd      String   @default("12:30")
  afternoonStart  String   @default("13:00")
  afternoonEnd    String   @default("17:00")
  maxDailyHours   Float    @default(16)  // Max billable hours per day (admin-configurable)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  identifiers     EmployeeIdentifier[]
  roles           EmployeeRole[]
  timesheets      Timesheet[]
  xeroSettings    EmployeeXeroSettings?
  leaveRequests   LeaveRequest[]
  xeroInvoices    XeroInvoice[]
}

model EmployeeIdentifier {
  id              Int      @id @default(autoincrement())
  employeeId      Int
  identifierType  String   // e.g., "payroll", "contractor_id", "hr_system"
  identifierValue String
  companyId       Int?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  company  Company? @relation(fields: [companyId], references: [id])

  @@unique([employeeId, identifierType, companyId])
}

model Role {
  id         Int      @id @default(autoincrement())
  name       String
  companyId  Int
  payRate    Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  company              Company                   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  employeeRoles        EmployeeRole[]
  timesheetEntries     TimesheetEntry[]
  xeroEarningsRateMaps XeroEarningsRateMapping[]

  @@unique([name, companyId])
}

model EmployeeRole {
  id         Int      @id @default(autoincrement())
  employeeId Int
  roleId     Int
  companyId  Int
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  role     Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([employeeId, roleId, companyId])
}

model Timesheet {
  id             Int      @id @default(autoincrement())
  employeeId     Int
  weekStarting   DateTime
  weekEnding     DateTime
  status         String   @default("OPEN")
  submittedAt    DateTime?
  approvedAt     DateTime?
  approvedById   Int?
  tsDataPeriodId String?          // DE period ID from TSDATA
  tsDataStatus   String?          // Authoritative status from TSDATA
  tsDataSyncedAt DateTime?        // Last sync timestamp
  autoCreated    Boolean  @default(false) // Auto-created by TSDATA sync
  verified       Boolean  @default(false) // All entries verified against TSDATA
  xeroTimesheetId String?  @unique // Xero timesheet ID
  xeroSyncedAt    DateTime?        // Last Xero sync timestamp
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  employee       Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approvedBy     User?              @relation("ApprovedBy", fields: [approvedById], references: [id])
  entries        TimesheetEntry[]
  wmsSyncLogs    WmsSyncLog[]
  xeroSyncLogs   XeroSyncLog[]
  invoiceEntries XeroInvoiceEntry[]

  @@unique([employeeId, weekStarting])
}

model TimesheetEntry {
  id           Int      @id @default(autoincrement())
  timesheetId  Int
  entryType    String
  date         DateTime
  startTime    String?  // HH:MM format e.g. "07:00"
  endTime      String?  // HH:MM format e.g. "17:00"
  hours        Float
  roleId       Int
  companyId    Int
  status       String   @default("OPEN")
  tsDataSource   Boolean  @default(false) // true if entry came from TSDATA
  tsDataEntryId  String?  @unique         // External ID from TSDATA
  tsDataSyncedAt DateTime?                // Last sync timestamp
  verified       Boolean  @default(false) // Verified against TSDATA
  startingLocation String? // School/location where this entry's work began
  startingLocationLat Float? // Latitude for starting location
  startingLocationLng Float? // Longitude for starting location
  reasonForDeviation String? // Reason for deviation from approved schedule (for WMS/TSSP)
  notes        String?  // Rich HTML content from WYSIWYG editor
  privateNotes String?  // Internal-only notes, not visible to clients
  locationNotes String? // JSON array of {location, description} pairs with HTML descriptions
  travelFrom   String?
  travelFromLat Float?  // Latitude for travel from location
  travelFromLng Float?  // Longitude for travel from location
  travelTo     String?
  travelToLat  Float?   // Latitude for travel to location
  travelToLng  Float?   // Longitude for travel to location
  distance     Float?
  isBillable   Boolean  @default(true) // Whether this entry is billable (important for WMS sync and reporting)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  timesheet Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)
  role      Role      @relation(fields: [roleId], references: [id])
  company   Company   @relation(fields: [companyId], references: [id])
}

model TimesheetApprover {
  id        Int      @id @default(autoincrement())
  companyId Int
  userId    Int
  email     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
}

model WmsSyncLog {
  id           Int       @id @default(autoincrement())
  timesheetId  Int
  status       String    // PENDING, RUNNING, COMPLETED, FAILED
  wmsUsername   String?
  startedAt    DateTime?
  completedAt  DateTime?
  errorMessage String?
  syncDetails  String?   // JSON: steps completed, entries synced, etc.
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  timesheet    Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)

  @@index([timesheetId])
  @@index([status])
}

model ApiKey {
  id         Int       @id @default(autoincrement())
  keyHash    String    @unique  // SHA-256 hash of the full key
  keyPrefix  String              // First 8 chars for display (e.g., "tsk_abcd")
  name       String              // Human-readable label
  userId     Int
  isActive   Boolean   @default(true)
  lastUsedAt DateTime?
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyHash])
}

model TsDataSyncLog {
  id               Int       @id @default(autoincrement())
  syncType         String    // FULL_SYNC, ENTRY_IMPORT, STATUS_UPDATE
  status           String    // SUCCESS, ERROR, PARTIAL
  employeeId       Int?
  timesheetId      Int?
  recordsProcessed Int       @default(0)
  recordsCreated   Int       @default(0)
  recordsUpdated   Int       @default(0)
  recordsSkipped   Int       @default(0)
  errorMessage     String?
  syncDetails      String?   // JSON details
  startedAt        DateTime  @default(now())
  completedAt      DateTime?
  createdAt        DateTime  @default(now())

  @@index([syncType, status])
  @@index([startedAt])
}

model PlaceCache {
  id            Int      @id @default(autoincrement())
  placeName     String   @unique
  address       String
  latitude      Float
  longitude     Float
  googlePlaceId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// === XERO INTEGRATION MODELS ===

model XeroToken {
  id            Int      @id @default(autoincrement())
  tenantId      String   @unique
  tenantName    String
  accessToken   String   // AES-256 encrypted
  refreshToken  String   // AES-256 encrypted
  expiresAt     DateTime
  scope         String
  isActive      Boolean  @default(true)
  lastSyncedAt  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  companies     CompanyXeroMapping[]
  syncLogs      XeroSyncLog[]
}

model CompanyXeroMapping {
  id            Int      @id @default(autoincrement())
  companyId     Int
  xeroTokenId   Int
  xeroTenantId  String
  xeroContactId String?  // Xero contact ID for invoicing
  invoiceRate   Float?   // Hourly rate for LT invoices

  company    Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  xeroToken  XeroToken  @relation(fields: [xeroTokenId], references: [id], onDelete: Cascade)

  @@unique([companyId, xeroTokenId])
}

model XeroEarningsRateMapping {
  id                  Int    @id @default(autoincrement())
  roleId              Int
  xeroTenantId        String
  xeroEarningsRateId  String
  earningsRateName    String

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, xeroTenantId])
}

model XeroSyncLog {
  id               Int      @id @default(autoincrement())
  xeroTokenId      Int?
  syncType         String   // TIMESHEET_SYNC, INVOICE_CREATE, LEAVE_SYNC, RECONCILIATION
  status           String   // PENDING, SUCCESS, ERROR, PARTIAL
  timesheetId      Int?
  xeroTimesheetId  String?
  xeroInvoiceId    String?
  xeroPayrunId     String?
  xeroLeaveId      String?
  recordsProcessed Int      @default(0)
  recordsSuccess   Int      @default(0)
  recordsFailed    Int      @default(0)
  errorMessage     String?
  syncDetails      String?  // JSON: differences, validation results
  startedAt        DateTime @default(now())
  completedAt      DateTime?

  xeroToken  XeroToken? @relation(fields: [xeroTokenId], references: [id], onDelete: SetNull)
  timesheet  Timesheet? @relation(fields: [timesheetId], references: [id], onDelete: Cascade)

  @@index([syncType, status])
  @@index([timesheetId])
}

model EmployeeXeroSettings {
  id           Int     @id @default(autoincrement())
  employeeId   Int     @unique
  employeeType String  @default("ST") // "ST" (Specialist Tech) or "LT" (Local Tech)
  autoApprove  Boolean @default(false)
  syncEnabled  Boolean @default(true)

  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model LeaveRequest {
  id            Int      @id @default(autoincrement())
  employeeId    Int
  leaveType     String   // ANNUAL, SICK, PERSONAL, UNPAID
  startDate     DateTime
  endDate       DateTime
  totalHours    Float
  status        String   @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED
  notes         String?
  approvedById  Int?
  approvedAt    DateTime?
  xeroLeaveId   String?  @unique
  xeroSyncedAt  DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approvedBy User?    @relation(fields: [approvedById], references: [id])

  @@index([employeeId, status])
}

model XeroInvoice {
  id            Int      @id @default(autoincrement())
  employeeId    Int
  companyId     Int
  xeroTenantId  String
  xeroInvoiceId String?  @unique
  invoiceMonth  DateTime // First day of month
  status        String   @default("DRAFT") // DRAFT, SUBMITTED, SENT, PAID
  totalHours    Float    @default(0)
  hourlyRate    Float
  totalAmount   Float    @default(0)
  sentAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  employee Employee           @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  company  Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  entries  XeroInvoiceEntry[]

  @@unique([employeeId, companyId, invoiceMonth])
  @@index([status])
}

model XeroInvoiceEntry {
  id          Int    @id @default(autoincrement())
  invoiceId   Int
  timesheetId Int
  hours       Float
  description String?

  invoice   XeroInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  timesheet Timesheet   @relation(fields: [timesheetId], references: [id], onDelete: Cascade)

  @@unique([invoiceId, timesheetId])
}

model XeroPayrun {
  id           Int      @id @default(autoincrement())
  xeroTenantId String
  xeroPayrunId String   @unique
  periodStart  DateTime
  periodEnd    DateTime
  paymentDate  DateTime
  status       String   // DRAFT, POSTED, PAID

  @@index([periodStart, status])
}
